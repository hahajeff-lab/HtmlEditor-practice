<!DOCTYPE html>
<html>
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c3e50">    
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的離線 HTML 編輯器</title>
    
    <link rel="stylesheet" href="codemirror.css">
　　<link rel="stylesheet" href="monokai.css">
    
<style>
    /* 1. 地基：讓 body 變成一個垂直的盒子 */
    html, body { 
        margin: 0; 
        padding: 0; 
        height: 100%; 
        display: flex; 
        flex-direction: column; 
        background: #1e1e1e; /* 網頁底色 */
    }

    /* 2. 標題欄：使用 flex 讓標題與按鈕群左右對齊 */
    .header {
        height: 55px;
        background: #2c3e50; /* 選用深藍灰色，讓白色按鈕更明顯 */
        color: #ddd;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        flex-shrink: 0;
        font-family: sans-serif;
        border-bottom: 1px solid #1a252f;
    }

    /* 按鈕容器 */
    .file-ops {
        display: flex;
        gap: 8px; /* 按鈕間的距離 */
    }

    /* 你要求的簡約白色圓角框按鈕 */
    .file-ops button {
        background: transparent;
        color: white;
        border: 1px solid white;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 14px;
        cursor: pointer;
        transition: 0.2s;
    }

    /* 點擊時顏色反轉的反饋效果 */
    .file-ops button:active {
        background: white;
        color: #2c3e50;
    }

    /* 3. 編輯器主體 */
    .CodeMirror { 
        flex: 1; 
        height: 100% !important; 
        font-size: 16px; 
    }

/* 分頁按鈕樣式 */
    .tabs {
        display: flex;
        background: #2c3e50;
        flex-shrink: 0;
    }
    .tabs button {
        flex: 1;
        padding: 10px;
        background: #34495e;
        color: #bdc3c7;
        border: none;
        outline: none;
        cursor: pointer;
        font-size: 14px;
    }
    .tabs button.active {
        background: #1e1e1e; /* 與編輯器同色 */
        color: white;
        border-bottom: 2px solid #3498db;
    }

    /* 預覽視窗樣式 */
    #preview-window {
        display: none; /* 預設隱藏 */
        flex-grow: 1;
        width: 100%;
        border: none;
        background: white; /* 網頁預覽通常用白底 */
    }

/* 方便符號樣式 */
.symbol-bar {
        display: flex;
        background: #333;
        padding: 5px;
        overflow-x: auto; /* 寬度不夠時可滑動 */
        white-space: nowrap;
        flex-shrink: 0;
        border-bottom: 1px solid #444;
    }

    .symbol-bar button {
        background: #444;
        color: white;
        border: 1px solid #555;
        border-radius: 4px;
        padding: 8px 12px;
        margin-right: 6px;
        font-size: 16px;
        flex-shrink: 0; /* 防止按鈕被壓扁 */
    }

    .symbol-bar button:active {
        background: #666;
    }
</style>
</head>
<body>
    <div class="header">
<div class="title">HTML Editor</div>
    
<div class="file-ops">
        <button onclick="newFile()">新建</button>
        <button onclick="saveFile()">存檔</button>
        <button onclick="loadFile()">讀取</button>
    </div>
 </div>

<div class="tabs"><!--分頁標籤-->
    <button id="edit-tab" class="active" onclick="switchTab('edit')">編輯程式碼</button>
    <button id="preview-tab" onclick="switchTab('preview')">即時預覽</button>
</div>

<div class="symbol-bar"><!--手機方便符號-->
    <button onclick="addBrackets()">&lt;&gt;</button> <button onclick="addQuotes()">""</button>      
<button onclick="addParentheses()">()</button> <button onclick="addChar('/')">/</button>   
<button onclick="addChar('/')">/</button>
    <button onclick="addChar('=')">=</button>
    <button onclick="addChar('!')">!</button>
    <button onclick="addChar(' ')">空格</button>
<button onclick="addChar('\t')">Tab</button>
</div>

<textarea id="my-code-area"></textarea><!--編輯區-->
<iframe id="preview-window"></iframe><!--預覽分頁-->
    <script src="codemirror.js"></script>
    <script src="xml.js"></script>

    <script>
var editor; // 在最外層宣告，它是全域的大腦
        if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
    .then(() => console.log("離線功能已啟動"));
}
window.onload = function() {
            // 嘗試從本地儲存讀取舊內容
            var saved = localStorage.getItem("my_code") || "<h1>你好！</h1>";

           editor = CodeMirror.fromTextArea(document.getElementById("my-code-area"), {
                lineNumbers: true,
                mode: "text/html",
                lineWrapping: true,
                htmlMode: true,
                autofocus: true,
		theme: "monokai"  // <--- 加入這一行，換上深色衣服！
            });

            editor.setValue(saved);

            // 自動儲存功能
            editor.on("change", function() {
                localStorage.setItem("my_code", editor.getValue());
            });

            // 強制刷新以確保顯示正常
            setTimeout(function() { editor.refresh(); }, 200);
        };
//插入符號功能
function addChar(char) {
    if (editor) {
        // 取得目前的游標位置
        var cursor = editor.getCursor();
        // 在該位置插入字元
        editor.replaceRange(char, cursor);
        // 重要：讓編輯器重新獲得焦點，手機鍵盤才不會縮回去
        editor.focus();
    }
}
//自動兩個雙引號
function addQuotes() {
    var cursor = editor.getCursor();
    editor.replaceRange('""', cursor);
    // 把游標往回移動一格，停在兩個引號中間
    editor.setCursor({ line: cursor.line, ch: cursor.ch + 1 });
    editor.focus();
}
// 成對尖括號 <>
function addBrackets() {
    if (editor) {
        var cursor = editor.getCursor();
        editor.replaceRange('<>', cursor);
        editor.setCursor({ line: cursor.line, ch: cursor.ch + 1 });
        editor.focus();
    }
}

// 成對括號 () - 之後寫 CSS 或 JS 可能用到
function addParentheses() {
    if (editor) {
        var cursor = editor.getCursor();
        editor.replaceRange('()', cursor);
        editor.setCursor({ line: cursor.line, ch: cursor.ch + 1 });
        editor.focus();
    }
}
// 1. 新建檔案
function newFile() {
    if (confirm("確定要新建檔案嗎？未存檔的內容將會消失。")) {
        window.editor.setValue("<!DOCTYPE html>\n<html>\n<body>\n\n</body>\n</html>");
    }
}

// 2. 存檔 (下載為 HTML 檔案)
function saveFile() {
    var content = window.editor.getValue();
    var blob = new Blob([content], { type: "text/html" });
    var a = document.createElement("a");
    
    // 檔名設定 (可以加入時間避免重複)
    var fileName = "my_code_" + new Date().getTime() + ".html";
    
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
// 關鍵修正：必須加入 body 才能在部分環境觸發 click
    document.body.appendChild(a);
    a.click();
document.body.removeChild(a); // 用完即丟
    URL.revokeObjectURL(a.href);
}

// 3. 讀取本地檔案
function loadFile() {
    // 建立一個隱藏的 input 來選檔案
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = '.html,.txt';
    
    input.onchange = e => {
        var file = e.target.files[0];
if (!file) return;
        var reader = new FileReader();
        reader.onload = readerEvent => {
            var content = readerEvent.target.result;
            editor.setValue(content);
        }
        reader.readAsText(file, 'UTF-8');
    }
    input.click();
}

function switchTab(mode) {
    var editTab = document.getElementById('edit-tab');
    var previewTab = document.getElementById('preview-tab');
    var editorEl = document.querySelector('.CodeMirror'); // CodeMirror 產生的容器
    var previewEl = document.getElementById('preview-window');

    if (mode === 'preview') {
        // 1. 切換按鈕狀態
        editTab.classList.remove('active');
        previewTab.classList.add('active');
        
        // 2. 顯示預覽，隱藏編輯
        editorEl.style.display = 'none';
        previewEl.style.display = 'block';
        
        // 3. 把程式碼渲染到 iframe 裡
        var code = editor.getValue();
        var previewDoc = previewEl.contentDocument || previewEl.contentWindow.document;
        previewDoc.open();
        previewDoc.write(code);
        previewDoc.close();
    } else {
        // 切換回編輯模式
        editTab.classList.add('active');
        previewTab.classList.remove('active');
        editorEl.style.display = 'block';
        previewEl.style.display = 'none';
        
        // 回到編輯器後重新整理一下，防止跑版
        editor.refresh();
    }
}

    </script>
</body>
</html>